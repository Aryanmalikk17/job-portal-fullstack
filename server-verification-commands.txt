# Step 1: Basic Server Verification Commands
# Run these commands one by one on your DigitalOcean server

echo "ğŸ” STEP 1: BASIC VERIFICATION"
echo "=============================="

# Check current directory
pwd

# Navigate to deployment directory
cd /opt/jobportal

# List all files in deployment directory
echo "ğŸ“ Files in deployment directory:"
ls -la

# Check if docker-compose.prod.yml exists
echo "ğŸ“‹ Docker Compose Production File:"
ls -la docker-compose.prod.yml

echo "ğŸ³ STEP 2: DOCKER SYSTEM STATUS"
echo "==============================="

# Check Docker version
docker --version

# Check Docker Compose version
docker-compose --version

# Check Docker daemon status
systemctl status docker

# List all Docker containers (running and stopped)
echo "ğŸ“Š All Docker Containers:"
docker ps -a

# List only running containers
echo "ğŸ”„ Currently Running Containers:"
docker ps

echo "ğŸ¯ STEP 3: JOB PORTAL CONTAINERS"
echo "================================"

# Check specific Job Portal containers
echo "ğŸ“‹ Expected Job Portal Containers Status:"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}" | grep jobportal

# Check if all expected containers are running
echo "ğŸ” Individual Container Check:"
docker ps | grep jobportal-mysql-prod && echo "âœ… MySQL - Running" || echo "âŒ MySQL - Not Running"
docker ps | grep jobportal-redis-prod && echo "âœ… Redis - Running" || echo "âŒ Redis - Not Running" 
docker ps | grep jobportal-backend-prod && echo "âœ… Backend - Running" || echo "âŒ Backend - Not Running"
docker ps | grep jobportal-frontend-prod && echo "âœ… Frontend - Running" || echo "âŒ Frontend - Not Running"
docker ps | grep jobportal-nginx-prod && echo "âœ… Nginx - Running" || echo "âŒ Nginx - Not Running"

# Check container health status
echo "ğŸ¥ Container Health Status:"
docker ps --format "table {{.Names}}\t{{.Status}}" | grep jobportal

echo "ğŸ“‹ STEP 4: DOCKER IMAGES AND NETWORKS"
echo "====================================="

# Check all Docker images
echo "ğŸ–¼ï¸ All Docker Images:"
docker images

# Check specifically for Job Portal images
echo "ğŸ¯ Job Portal Images:"
docker images | grep jobportal

# Check GitHub Container Registry images
echo "ğŸ“¦ GitHub Container Registry Images:"
docker images | grep ghcr.io

# Check Docker networks
echo "ğŸŒ Docker Networks:"
docker network ls

# Check Job Portal network
echo "ğŸ”— Job Portal Network:"
docker network ls | grep jobportal

# Check Docker volumes
echo "ğŸ’¾ Docker Volumes:"
docker volume ls

echo "ğŸ¥ STEP 5: APPLICATION HEALTH TESTS"
echo "==================================="

# Test Frontend (Nginx) locally
echo "ğŸŒ Testing Frontend (Nginx):"
curl -I http://localhost/

# Test Backend API locally  
echo "âš™ï¸ Testing Backend API:"
curl -I http://localhost:8080/actuator/health

# Test MySQL database connectivity
echo "ğŸ’¾ Testing MySQL Database:"
docker exec jobportal-mysql-prod mysqladmin ping -u root -pZpluseRootPass2025! || echo "MySQL connection failed"

# Test Redis cache connectivity
echo "ğŸ“Š Testing Redis Cache:"
docker exec jobportal-redis-prod redis-cli -a ZpluseRedisPass2025! ping || echo "Redis connection failed"

# Test external domain access
echo "ğŸŒ Testing External Domain Access:"
curl -I https://zplusejobs.com/

# Check port availability
echo "ğŸ”Œ Checking Port Status:"
netstat -tlnp | grep :80
netstat -tlnp | grep :443
netstat -tlnp | grep :8080
netstat -tlnp | grep :3306
netstat -tlnp | grep :6379

echo "ğŸ“ STEP 6: CONTAINER LOGS ANALYSIS"
echo "=================================="

# Check recent logs for each container (last 20 lines)
echo "ğŸ” MySQL Container Logs:"
docker logs jobportal-mysql-prod --tail 20

echo "ğŸ” Redis Container Logs:"
docker logs jobportal-redis-prod --tail 20

echo "ğŸ” Backend Container Logs:"
docker logs jobportal-backend-prod --tail 20

echo "ğŸ” Frontend Container Logs:"
docker logs jobportal-frontend-prod --tail 20

echo "ğŸ” Nginx Container Logs:"
docker logs jobportal-nginx-prod --tail 20

# Check for any error patterns in logs
echo "âš ï¸ Checking for errors in container logs:"
docker logs jobportal-backend-prod 2>&1 | grep -i error | tail -5
docker logs jobportal-nginx-prod 2>&1 | grep -i error | tail -5

echo "ğŸ“Š STEP 7: SYSTEM RESOURCES AND PERFORMANCE"
echo "==========================================="

# Check system memory usage
echo "ğŸ’¾ Memory Usage:"
free -h

# Check disk usage
echo "ğŸ’½ Disk Usage:"
df -h

# Check Docker system usage
echo "ğŸ³ Docker System Usage:"
docker system df

# Check system load
echo "âš¡ System Load:"
uptime

# Check running processes
echo "ğŸ”„ Top Processes:"
top -bn1 | head -20

# Check if any containers are consuming too much memory
echo "ğŸ” Container Resource Usage:"
docker stats --no-stream