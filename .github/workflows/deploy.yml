name: ðŸš€ Deploy Job Portal to DigitalOcean

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend
  # Convert repository name to lowercase for Docker registry compatibility
  REPO_LOWERCASE: ${{ github.repository_owner }}/${{ github.event.repository.name }}

jobs:
  # Build and Push Docker Images
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ”§ Prepare repository name (lowercase)
      id: repo
      run: echo "lowercase=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: ðŸ“¦ Extract metadata (tags, labels) for Backend
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ steps.repo.outputs.lowercase }}-backend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: ðŸ“¦ Extract metadata (tags, labels) for Frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ steps.repo.outputs.lowercase }}-frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: ðŸ—ï¸ Build and push Backend Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}

    - name: ðŸ—ï¸ Build and push Frontend Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile.prod
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        build-args: |
          REACT_APP_API_BASE_URL=https://${{ secrets.DOMAIN_NAME }}/api
          REACT_APP_JWT_STORAGE_KEY=zpluse_jwt_token
          REACT_APP_USER_STORAGE_KEY=zpluse_user_info
          REACT_APP_REFRESH_TOKEN_KEY=zpluse_refresh_token
          REACT_APP_APP_NAME=Zpluse Jobs Finder
          REACT_APP_ENVIRONMENT=production
          GENERATE_SOURCEMAP=false

  # Deploy to DigitalOcean
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}

    - name: ðŸ”§ Prepare repository name (lowercase)
      id: repo
      run: echo "lowercase=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: ðŸ“‹ Create environment file
      run: |
        cat > .env << EOF
        # Database Configuration
        MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
        MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        
        # JWT Configuration
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        
        # Email Configuration
        MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
        MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
        
        # Domain Configuration
        DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
        
        # Docker Images (lowercase for registry compatibility)
        BACKEND_IMAGE=ghcr.io/${{ steps.repo.outputs.lowercase }}-backend:latest
        FRONTEND_IMAGE=ghcr.io/${{ steps.repo.outputs.lowercase }}-frontend:latest
        
        # Application Configuration
        SERVER_PORT=8080
        UPLOAD_MAX_SIZE=10MB
        SPRING_PROFILES_ACTIVE=prod
        ENVIRONMENT=production
        
        # Database Connection
        DB_HOST=mysql
        DB_PORT=3306
        DB_NAME=${{ secrets.MYSQL_DATABASE }}
        DB_USERNAME=jobportal
        
        # Redis Configuration
        REDIS_HOST=redis
        REDIS_PORT=6379
        
        # SMTP Configuration
        MAIL_HOST=smtp.gmail.com
        MAIL_PORT=587
        MAIL_PROTOCOL=smtp
        MAIL_AUTH=true
        MAIL_STARTTLS_ENABLE=true
        MAIL_STARTTLS_REQUIRED=true
        MAIL_DEBUG=false
        
        # CORS Configuration
        CORS_ALLOWED_ORIGINS=https://${{ secrets.DOMAIN_NAME }},https://www.${{ secrets.DOMAIN_NAME }}
        EOF

    - name: ðŸŒ Update Nginx configuration with domain
      run: |
        # Replace hardcoded domain with actual domain from secrets
        sed -i "s/zplusejobs.com/${{ secrets.DOMAIN_NAME }}/g" nginx/nginx.prod.conf
        sed -i "s/www.zplusejobs.com/www.${{ secrets.DOMAIN_NAME }}/g" nginx/nginx.prod.conf

    - name: ðŸ“¦ Copy files to server
      run: |
        # Add server to known hosts with timeout
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # Create deployment directory with timeout
        timeout 30 ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p /opt/jobportal/deployment"
        
        # Copy deployment files with timeout
        echo "ðŸ”„ Copying docker-compose.prod.yml..."
        timeout 60 scp -o ConnectTimeout=30 docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/jobportal/
        
        echo "ðŸ”„ Copying .env..."
        timeout 60 scp -o ConnectTimeout=30 .env ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/jobportal/
        
        echo "ðŸ”„ Copying nginx configuration..."
        timeout 60 scp -r -o ConnectTimeout=30 nginx/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/jobportal/
        
        echo "ðŸ”„ Copying database scripts..."
        timeout 60 scp -r -o ConnectTimeout=30 DB_Scripts/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/jobportal/
        
        echo "ðŸ”„ Copying deployment scripts (excluding logs)..."
        timeout 60 rsync -avz -e "ssh -o ConnectTimeout=30" --exclude='*.log' --exclude='logs/' scripts/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/jobportal/scripts/
        
        echo "âœ… All files copied successfully"

    - name: ðŸ³ Deploy with Docker Compose
      run: |
        # Create deployment script
        cat > deploy-script.sh << 'SCRIPT_EOF'
        #!/bin/bash
        set -e
        cd /opt/jobportal
        
        # Use temporary Docker config to avoid permission issues
        export DOCKER_CONFIG=/tmp/.docker-$RANDOM
        mkdir -p $DOCKER_CONFIG
        
        # Login to GitHub Container Registry
        echo "ðŸ” Logging into GitHub Container Registry..."
        echo "LOGIN_TOKEN" | docker --config $DOCKER_CONFIG login ghcr.io -u "LOGIN_USER" --password-stdin
        
        # Stop and remove existing containers
        echo "ðŸ›‘ Removing existing containers..."
        docker-compose -f docker-compose.prod.yml down --remove-orphans --volumes || true
        
        # Pull latest images
        echo "ðŸ“¥ Pulling latest Docker images..."
        # Source .env to get image names if needed, but docker-compose pull should handle it if .env is present
        # However, for explicit pull we might need to know the image name. 
        # Better: let docker-compose pull handle it using the .env file.
        docker-compose -f docker-compose.prod.yml --env-file .env pull
        
        # Prune old images/containers
        docker container prune -f
        docker network prune -f
        
        # Deploy
        echo "ðŸš€ Starting deployment..."
        # We explicitly use --env-file .env to ensure it's picked up
        docker-compose -f docker-compose.prod.yml --env-file .env up -d --force-recreate
        
        # Wait and verify
        echo "â³ Waiting for services..."
        sleep 60
        docker-compose -f docker-compose.prod.yml ps
        
        # Cleanup
        rm -rf $DOCKER_CONFIG
        echo "âœ… Deployment completed!"
        SCRIPT_EOF
        
        # Replace placeholders for Docker Login only (safer than replacing all secrets)
        sed -i "s/LOGIN_TOKEN/${{ secrets.GITHUB_TOKEN }}/g" deploy-script.sh
        sed -i "s/LOGIN_USER/${{ github.actor }}/g" deploy-script.sh
        
        # Copy and execute deployment script
        scp deploy-script.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/jobportal/
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "chmod +x /opt/jobportal/deploy-script.sh && /opt/jobportal/deploy-script.sh"

    - name: ðŸ” Setup SSL Certificate
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        # Skip SSL setup if not running as root (avoid sudo password issues)
        if [ "$EUID" -ne 0 ]; then
          echo "âš ï¸ Skipping SSL setup - requires root access"
          echo "ðŸ’¡ Manual SSL setup required after deployment"
        else
          # Install SSL certificate for domain (only if running as root)
          certbot --nginx -d ${{ secrets.DOMAIN_NAME }} -d www.${{ secrets.DOMAIN_NAME }} --non-interactive --agree-tos --email ${{ secrets.MAIL_USERNAME }}
        fi
        EOF

    - name: ðŸ§¹ Cleanup old images
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        # Remove old Docker images to save space
        docker image prune -f
        docker container prune -f
        EOF

    - name: ðŸ“Š Deployment Summary
      run: |
        echo "ðŸŽ‰ Deployment completed successfully!"
        echo "ðŸ“± Application: https://${{ secrets.DOMAIN_NAME }}"
        echo "ðŸ” API Health: https://${{ secrets.DOMAIN_NAME }}/api/actuator/health"
        echo "ðŸ“§ Deployed by: ${{ github.actor }}"
        echo "ðŸ·ï¸ Commit: ${{ github.sha }}"
        echo "ðŸ• Time: $(date)"