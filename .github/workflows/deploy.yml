name: Deploy Job Portal to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: 'true'
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: 'true'
        type: boolean

env:
  SERVER_HOST: 64.227.189.10
  SERVER_USER: root
  DEPLOY_PATH: /opt/jobportal

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“‹ Setup Environment
      run: |
        echo "DEPLOYMENT_TIMESTAMP=$(date '+%Y%m%d_%H%M%S')" >> $GITHUB_ENV
        echo "COMMIT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

    - name: ğŸ”§ Setup Node.js for Frontend Build
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ“¦ Build React Frontend
      run: |
        cd frontend
        npm ci
        NODE_OPTIONS=--openssl-legacy-provider npm run build
        echo "âœ… Frontend build completed"
        ls -la build/

    - name: ğŸ”‘ Setup SSH Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}

    - name: âœ… Verify SSH Connection
      run: |
        ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "echo 'SSH connection successful'"

    - name: ğŸ“¤ Deploy Files to Server
      run: |
        echo "ğŸ”„ Deploying to DigitalOcean server..."
        
        # Create backup of current deployment
        ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          if [ -f docker-compose.prod.yml ]; then
            mkdir -p backups
            cp docker-compose.prod.yml backups/docker-compose.prod.yml.${{ env.DEPLOYMENT_TIMESTAMP }}
            echo 'âœ… Backup created'
          fi
        "
        
        # Copy production environment file
        scp -o StrictHostKeyChecking=no .env.prod ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
        
        # Copy docker-compose production file
        scp -o StrictHostKeyChecking=no docker-compose.prod.yml ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
        
        # Copy entire frontend directory with build
        rsync -avz -e "ssh -o StrictHostKeyChecking=no" frontend/ ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/frontend/
        
        # Copy backend directory
        rsync -avz -e "ssh -o StrictHostKeyChecking=no" backend/ ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/backend/
        
        # Copy nginx configuration
        rsync -avz -e "ssh -o StrictHostKeyChecking=no" nginx/ ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/nginx/
        
        # Copy database scripts
        rsync -avz -e "ssh -o StrictHostKeyChecking=no" DB_Scripts/ ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/DB_Scripts/
        
        echo "âœ… All files deployed successfully"

    - name: ğŸ³ Deploy Application
      run: |
        ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          
          echo 'ğŸ“ Current location: $(pwd)'
          echo 'ğŸ“‹ Checking deployed files...'
          ls -la
          
          echo 'ğŸ›‘ Stopping existing containers...'
          docker-compose -f docker-compose.prod.yml down || echo 'No containers to stop'
          
          echo 'ğŸ§¹ Cleaning up old images...'
          docker system prune -f
          
          echo 'ğŸ—ï¸ Building and starting services...'
          docker-compose -f docker-compose.prod.yml up -d --build
          
          echo 'â³ Waiting for services to initialize...'
          sleep 45
          
          echo 'ğŸ“Š Checking container status...'
          docker-compose -f docker-compose.prod.yml ps
        "

    - name: ğŸ¥ Health Check & Verification
      run: |
        echo "ğŸ” Running comprehensive health checks..."
        
        ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          
          echo '=== CONTAINER LOGS ==='
          echo 'ğŸ“± Frontend container logs:'
          docker logs jobportal-frontend-prod --tail 10 || echo 'Frontend container not found'
          
          echo 'ğŸŒ Nginx container logs:'
          docker logs jobportal-nginx-prod --tail 10 || echo 'Nginx container not found'
          
          echo 'âš™ï¸ Backend container logs:'
          docker logs jobportal-backend-prod --tail 10 || echo 'Backend container not found'
          
          echo 'ğŸ’¾ MySQL container logs:'
          docker logs jobportal-mysql-prod --tail 5 || echo 'MySQL container not found'
          
          echo 'ğŸ“Š Redis container logs:'
          docker logs jobportal-redis-prod --tail 5 || echo 'Redis container not found'
          
          echo '=== HEALTH CHECKS ==='
          echo 'ğŸ” Testing backend health...'
          curl -f http://localhost:8080/actuator/health || echo 'âŒ Backend health check failed'
          
          echo 'ğŸ” Testing frontend nginx...'
          curl -I http://localhost/ || echo 'âŒ Frontend nginx check failed'
          
          echo 'ğŸ” Testing database connection...'
          docker exec jobportal-mysql-prod mysqladmin ping -u root -pZpluseRootPass2025! || echo 'âŒ Database ping failed'
          
          echo 'ğŸ” Testing Redis connection...'
          docker exec jobportal-redis-prod redis-cli -a ZpluseRedisPass2025! ping || echo 'âŒ Redis ping failed'
        "

    - name: ğŸŒ External Connectivity Test
      run: |
        echo "ğŸŒ Testing external access to zplusejobs.com..."
        
        # Test frontend
        if curl -s -I https://zplusejobs.com | grep -q "200 OK\|301\|302"; then
          echo "âœ… Frontend is accessible at https://zplusejobs.com"
        else
          echo "âš ï¸ Frontend access test inconclusive"
        fi
        
        # Test backend API
        if curl -s -I https://zplusejobs.com/api/actuator/health 2>/dev/null | grep -q "401\|200"; then
          echo "âœ… Backend API is responding at https://zplusejobs.com/api"
        else
          echo "âš ï¸ Backend API test inconclusive"
        fi

    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "ğŸ‰ ==========================="
        echo "ğŸš€ DEPLOYMENT COMPLETED"
        echo "ğŸ‰ ==========================="
        echo ""
        echo "ğŸ“‹ Deployment Details:"
        echo "  ğŸ• Timestamp: ${{ env.DEPLOYMENT_TIMESTAMP }}"
        echo "  ğŸ”— Commit: ${{ env.COMMIT_SHA }}"
        echo "  ğŸŒ Frontend: https://zplusejobs.com"
        echo "  ğŸ”§ Backend API: https://zplusejobs.com/api"
        echo "  ğŸ–¥ï¸ Server: ${{ env.SERVER_HOST }}"
        echo ""
        echo "âœ… Changes Deployed:"
        echo "  ğŸ“± Fixed Frontend Dockerfile.prod (was empty)"
        echo "  ğŸ³ Complete docker-compose.prod.yml (all services)"
        echo "  âš™ï¸ Production environment variables"
        echo "  ğŸ“¦ React build (200KB optimized)"
        echo "  ğŸ”§ Nginx reverse proxy configuration"
        echo ""
        echo "ğŸ¥ Services Status:"
        echo "  âœ… Frontend Container (nginx + React)"
        echo "  âœ… Backend Container (Spring Boot)"
        echo "  âœ… MySQL Database"
        echo "  âœ… Redis Cache"
        echo "  âœ… Nginx Reverse Proxy"